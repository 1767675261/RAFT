### **可测试规则语言（TRL）完整定义**

---

### **1. 符号系统（Symbols）**
#### **逻辑符号**
| 符号 | 作用位置          | 语义角色                          |
|------|-------------------|-----------------------------------|
| `AND` | 条件/动作/结果组合 | 逻辑与，连接多个表达式            |
| `OR`  | 条件/动作/结果组合 | 逻辑或，连接多个表达式            |
| `NOT` | 条件/动作/结果组合 | 逻辑非，取反表达式                |

#### **比较符号**
| 符号 | 作用位置          | 语义角色                          |
|------|-------------------|-----------------------------------|
| `EQ` | 原子表达式        | 等于，比较两个值是否相等          |
| `NE` | 原子表达式        | 不等于，比较两个值是否不相等      |
| `LT` | 原子表达式        | 小于，比较数值大小                |
| `LE` | 原子表达式        | 小于等于，比较数值大小            |
| `GT` | 原子表达式        | 大于，比较数值大小                |
| `GE` | 原子表达式        | 大于等于，比较数值大小            |

#### **领域符号**
| 符号         | 语法位置       | 语义角色                          | 取值类型       |
|--------------|----------------|-----------------------------------|----------------|
| `Actor`      | 条件/动作      | 交易参与者（主做市商/一般做市商） | 字符串         |
| `BondType`   | 条件/结果      | 债券类型（基准做市品种/自定义品种） | 字符串         |
| `Market`     | 条件          | 交易市场（深交所/上交所）         | 字符串         |
| `TimeCondition` | 条件      | 时间约束（当日/非当日）           | 字符串         |
| `TradingDirection` | 动作    | 交易方向（买入/卖出）             | 字符串         |
| `TradingMethod` | 动作      | 交易方式（询价成交/点击成交等）   | 字符串         |
| `Price`      | 动作          | 交易价格                          | 数字           |
| `Quantity`   | 动作          | 交易数量（面额）                  | 数字           |
| `ResultStatus` | 结果      | 结果状态（成功/失败）             | 字符串         |
| `OrderStatus` | 结果      | 订单状态（未成交/部分成交）       | 字符串         |

---

### **2. 语法（Syntax）**
#### **BNF 定义**
```bnf
Rule ::= "IF" <Condition> "AND" <Action> "THEN" <ExpectedOutcome>

Condition ::= Expression
Action     ::= Expression
ExpectedOutcome ::= Expression

Expression ::= ComparisonExpression | LogicalExpression | PrimaryExpression
ComparisonExpression ::= PrimaryExpression ComparisonOperator Expression
LogicalExpression ::= PrimaryExpression LogicOperator Expression
PrimaryExpression ::= DomainProperty | Literal | '(' Expression ')'

DomainProperty ::= DomainSymbol '.' AttributeName
Literal ::= StringLiteral | NumberLiteral

LogicOperator ::= "AND" | "OR" | "NOT"
ComparisonOperator ::= "EQ" | "NE" | "LT" | "LE" | "GT" | "GE"

DomainSymbol ::= "Actor" | "BondType" | "Market" | "TimeCondition" | 
                 "TradingDirection" | "TradingMethod" | "Price" | "Quantity" |
                 "ResultStatus" | "OrderStatus"

AttributeName ::= [a-zA-Z_][a-zA-Z0-9_]*
StringLiteral ::= '"' ( ~'"' | '""' )* '"'
NumberLiteral ::= [0-9]+ ('.' [0-9]+)?
```

#### **语法说明**
- **一致性**：`Condition`、`Action`、`ExpectedOutcome` 均使用 `Expression` 结构。
- **嵌套支持**：通过 `()` 和逻辑/比较运算符支持复杂条件。
- **原子表达式**：`DomainProperty`（如 `Actor.type`）或 `Literal`（如 `"深交所"`）。
- **复合表达式**：通过 `AND/OR/NOT` 或比较符组合表达式。

---

### **3. 语义（Semantics）**
#### **操作语义**
**环境定义**：  
环境 `env` 是一个从 `DomainProperty` 到值（字符串/数字）的映射表，表示系统状态。

**表达式求值**：
```python
def evaluate(expr, env):
    if expr is PrimaryExpression:
        if expr is DomainProperty:
            return env[expr]  # 从环境取值
        else:  # Literal
            return expr.value
    elif expr is ComparisonExpression:
        left = evaluate(expr.left, env)
        right = evaluate(expr.right, env)
        return compare(left, expr.op, right)  # 执行比较操作
    elif expr is LogicalExpression:
        left = evaluate(expr.left, env)
        right = evaluate(expr.right, env)
        return logic(left, expr.op, right)  # 执行逻辑操作
```

**规则语义**：
```python
def rule_satisfied(rule, env):
    # 1. 求值条件
    if not evaluate(rule.Condition, env):
        return False
    
    # 2. 执行动作（改变环境）
    new_env = execute_action(rule.Action, env)
    
    # 3. 验证结果
    return evaluate(rule.ExpectedOutcome, new_env)

def execute_action(action_expr, env):
    # 模拟动作执行（如生成订单、更新状态）
    # 返回新环境 env'
    return new_env
```

#### **语义解释**
- **条件部分** → **输入约束**：  
  `Condition` 定义系统输入状态（如 `TimeCondition.time EQ "当日"`）。
- **动作部分** → **操作序列**：  
  `Action` 描述系统执行的操作（如 `TradingDirection EQ "卖出"`）。
- **结果部分** → **断言**：  
  `ExpectedOutcome` 定义操作后应满足的状态（如 `ResultStatus EQ "SUCCESS"`）。

---

### **4. 可测试性约束（Testability Constraints）**
#### **OCL 约束**
```ocl
-- 约束1: 条件中的所有域属性必须在环境中可设置
context Rule inv ConditionIsObservable:
    self.Condition.allDomainProperties()->forEach(dp |
        Environment.allInstances()->exists(env | env.hasProperty(dp))
    )

-- 约束2: 动作中的所有域属性必须在系统中可执行
context Rule inv ActionIsExecutable:
    self.Action.allDomainProperties()->forEach(dp |
        System.allInstances()->exists(sys | sys.supportsAction(dp))
    )

-- 约束3: 结果中的所有域属性必须在环境中可观测
context Rule inv ExpectedResultIsObservable:
    self.ExpectedOutcome.allDomainProperties()->forEach(dp |
        Environment.allInstances()->exists(env | env.hasProperty(dp))
    )

-- 约束4: 规则必须存在测试用例覆盖
context Rule inv RuleIsCoverable:
    Test.allInstances()->exists(t |
        t.Rule = self and 
        t.InputEnvironment |- self.Condition: true and 
        t.InputEnvironment |- self.Action: true and 
        t.OutputEnvironment |- self.ExpectedOutcome: true
    )

-- 辅助操作
context Expression def allDomainProperties(): Set(DomainProperty) =
    self->select(e | e.oclIsKindOf(DomainProperty))

context Environment def hasProperty(dp: DomainProperty): Boolean =
    properties->exists(prop | prop.key = dp.domainSymbol and prop.key = dp.attributeName)

context System def supportsAction(dp: DomainProperty): Boolean =
    supportedActions->includes(dp.attributeName)
```

#### **约束说明**
1. **条件可观测性**：确保测试用例能构造满足 `Condition` 的输入环境。
2. **动作可执行性**：确保系统能处理 `Action` 中定义的操作。
3. **结果可观测性**：确保测试用例能验证 `ExpectedOutcome`。
4. **规则可覆盖性**：存在测试用例覆盖规则的所有路径。

---

### **TRL 完整定义**
TRL 是一种形式化语言，用于将自然语言规则转化为可测试的结构化表达式。其核心特点：
- **符号系统**：逻辑/比较/领域符号支持复杂规则建模。
- **统一语法**：`Condition`、`Action`、`ExpectedOutcome` 均基于 `Expression` 结构。
- **操作语义**：通过环境求值和动作执行定义系统行为。
- **可测试性约束**：确保规则可被测试用例覆盖和验证。

---

### **示例：自然语言规则转化与可测试性验证**
#### **自然语言规则**
> **3.1.8 债券现券交易实行当日回转交易，投资者当日买入的债券可以在当日卖出。**

#### **TRL 规则实例**
```trl
IF 
  TimeCondition.time EQ "当日" AND 
  TradingDirection EQ "买入" AND 
  BondType.type EQ "现券"
AND
  TradingDirection EQ "卖出" AND 
  TimeCondition.time EQ "当日"
THEN
  ResultStatus EQ "SUCCESS"
```

#### **可测试性验证**
| 约束          | 验证结果 | 说明                                                                 |
|---------------|----------|----------------------------------------------------------------------|
| 条件可观测性  | ✅       | `TimeCondition.time`、`TradingDirection`、`BondType.type` 可设置。   |
| 动作可执行性  | ✅       | `TradingDirection EQ "卖出"` 系统支持。                             |
| 结果可观测性  | ✅       | `ResultStatus` 可观测。                                             |
| 规则可覆盖性  | ✅       | 测试用例覆盖：当日买入现券 → 当日卖出 → 结果成功。                   |

#### **测试用例示例**
```json
{
  "rule": "3.1.8",
  "testid": "T1",
  "input": {
    "TimeCondition.time": "当日",
    "TradingDirection": "买入",
    "BondType.type": "现券"
  },
  "action": {
    "TradingDirection": "卖出",
    "TimeCondition.time": "当日"
  },
  "expected": {
    "ResultStatus": "SUCCESS"
  },
  "result": "通过"
}
```

#### **结论**
- **转化有效性**：TRL 完整捕捉规则的核心逻辑（时间约束、交易方向、债券类型）。
- **可测试性满足**：所有约束通过，规则可被自动化测试覆盖。