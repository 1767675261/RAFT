# ✅ 最终统一语言：可测试规则语言 TRL（Unified）

---

## 0. 设计原则（合并说明）

在合并三种语言时，遵循以下规则：

1. **结构统一**
   所有规则统一为：

   ```
   IF <Condition> AND <Action> THEN <ExpectedOutcome>
   ```

2. **表达能力取并集**

   * 支持：

     * 字段级比较（语言 1 / 2）
     * 类.属性访问（语言 3）
     * 逻辑嵌套（AND / OR / NOT / 括号）
     * 动作既可以是赋值，也可以是操作调用
   * Action / ExpectedOutcome / Condition 均支持逻辑组合

3. **语义统一为“操作语义 + 断言语义”**

   * Condition → 输入/前置约束
   * Action → 操作或状态变更
   * ExpectedOutcome → 可验证断言

4. **可测试性约束全部保留（取并集）**

   * 可观测
   * 可执行
   * 可断言
   * 可满足（非死规则）
   * 类型一致
   * 无循环依赖
   * 至少一条可生成测试用例

---

# 1. 符号系统（Symbols）

### 1.1 逻辑符号（Logical Symbols）

```
IF, THEN
AND, OR, NOT
( )
```

* 用于组合 Condition / Action / ExpectedOutcome
* 支持任意嵌套

---

### 1.2 比较符号（Comparison Operators）

```
=   !=   >   <   >=   <=
```

* 用于字段与值之间的比较
* 适用于 Condition 与 ExpectedOutcome

---

### 1.3 领域符号（Domain Symbols）

#### 1.3.1 领域类（Class-Level）

```
BondType
TradingParticipant
OrderDirection
TradingTime
TransactionPrice
Quantity
TradingMethod
TradingStatus
SettlementMethod
SettlementCycle
Cancellation
RiskControl
TechnicalFault
MarketCondition
ComplianceStatus
TradeResult
```

#### 1.3.2 领域属性（Property-Level）

```
<ClassName>.<AttributeName>
```

示例：

```
BondType.name
TradingTime.hour
TradingStatus.value
TradingParticipant.id
```

> ✔ 同时支持：
>
> * **字段级**（语言 1 / 2）
> * **类.属性级**（语言 3）

---

### 1.4 常量（Literals）

* **字符串常量**

  ```
  "国债", "买入", "Success"
  ```
* **数字常量**

  ```
  100, 10.5
  ```

> 不使用枚举，便于测试数据生成（来自语言 2）

---

# 2. 语法（Syntax, BNF）

```bnf
Rule ::= "IF" Condition "AND" Action "THEN" ExpectedOutcome
```

---

## 2.1 Condition（条件）

```bnf
Condition ::= SimpleCondition
            | Condition "AND" Condition
            | Condition "OR" Condition
            | "NOT" Condition
            | "(" Condition ")"

SimpleCondition ::= Property ComparisonOperator Value
```

---

## 2.2 Action（动作）

```bnf
Action ::= SimpleAction
         | Action "AND" Action
         | Action "OR" Action
         | "NOT" Action
         | "(" Action ")"

SimpleAction ::= Assignment
               | OperationCall

Assignment ::= Property "=" Value
OperationCall ::= DomainSymbol "(" [Value {"," Value}] ")"
```

> ✔ 同时支持：
>
> * **赋值型动作**（语言 2）
> * **操作调用型动作**（语言 1 / 3）

---

## 2.3 ExpectedOutcome（预期结果）

```bnf
ExpectedOutcome ::= SimpleOutcome
                  | ExpectedOutcome "AND" ExpectedOutcome
                  | ExpectedOutcome "OR" ExpectedOutcome
                  | "NOT" ExpectedOutcome
                  | "(" ExpectedOutcome ")"

SimpleOutcome ::= Property ComparisonOperator Value
```

---

## 2.4 基础元素

```bnf
Property ::= DomainSymbol
DomainSymbol ::= ClassName | ClassName "." AttributeName

ComparisonOperator ::= "=" | "!=" | ">" | "<" | ">=" | "<="

Value ::= StringConstant | NumberConstant
```

---

# 3. 语义（Semantics）

TRL 采用 **操作语义（Operational Semantics）+ 断言语义**。

---

## 3.1 Rule 的整体语义

| 部分              | 语义角色        |
| --------------- | ----------- |
| Condition       | 输入约束 / 前置条件 |
| Action          | 操作或状态变更     |
| ExpectedOutcome | 可验证断言       |

---

## 3.2 执行流程（统一）

1. **评估 Condition**

   * 若为 `false` → 规则不触发
2. **执行 Action**

   * 执行赋值或操作调用
   * 更新系统状态
3. **验证 ExpectedOutcome**

   * 作为断言进行验证
4. **输出测试结果**

   * 成功 / 失败

---

## 3.3 逻辑符号语义

| 符号  | 语义     |
| --- | ------ |
| AND | 所有子句成立 |
| OR  | 至少一个成立 |
| NOT | 逻辑取反   |
| ( ) | 改变优先级  |

---

# 4. 可测试性约束（Testability Constraints, OCL）

> 以下 **全部来自三种语言的并集**，无删减。

---

## 4.1 基本结构约束

```ocl
context Rule
inv HasCondition:
    self.condition.fields()->size() > 0

inv HasAction:
    self.action.fields()->size() > 0

inv HasExpectedOutcome:
    self.expectedOutcome.fields()->size() > 0
```

---

## 4.2 条件可测试性

```ocl
context Rule
inv TestableCondition:
    self.condition.fields()->exists(f | f.isTestable())
```

---

## 4.3 动作可执行 & 可观测

```ocl
context Rule
inv ExecutableAction:
    self.action.operations()->forAll(op | op.isExecutable())

inv ObservableAction:
    self.action.fields()->exists(f | f.isObservable())
```

---

## 4.4 结果可验证

```ocl
context Rule
inv VerifiableOutcome:
    self.expectedOutcome.fields()->exists(f | f.isAssertable())
```

---

## 4.5 类型一致性

```ocl
context Rule
inv TypeConsistency:
    self.condition.properties()->forAll(p |
        p.type = self.expectedOutcome.properties()->any(q | q.name = p.name).type
    )
```

---

## 4.6 无循环依赖

```ocl
context Rule
inv NoCircularDependency:
    not self.action.causesCircularDependency(self.condition)
```

---

## 4.7 可满足性（避免死规则）

```ocl
context Rule
inv Satisfiable:
    self.condition.hasSatisfyingAssignment() = true
```

---

## 4.8 可预测性

```ocl
context Rule
inv Deterministic:
    self.expectedOutcome.isDeterministic()
```

---

## 4.9 最小测试集

```ocl
context Rule
inv MinimalTestSet:
    self.testSet->size() >= 1
```

---

## 4.10 字段能力定义（统一）

```ocl
context Field
def isTestable(): Boolean =
    self.isVariable()

def isObservable(): Boolean =
    self.isSystemState()

def isAssertable(): Boolean =
    self.isSystemState() or self.isOutput()
```

---

# 5. 示例（统一语言表达）

```trl
IF BondType.name = "国债"
   AND TradingTime.hour > 9
   AND TradingTime.hour < 11
   AND RiskControl = "已通过"
AND
TransactionPrice = 100.5
AND Quantity = 1000
AND TradingMethod("提交交易申报")
THEN
TradeResult = "Success"
AND TradingStatus.value = "已成交"
```

✔ 可解析
✔ 可执行
✔ 可生成测试用例
✔ 可验证断言

---

# 6. 三种语言的映射关系（你可用于论文/文档）

| 原语言  | 在最终 TRL 中的位置                         |
| ---- | ------------------------------------ |
| 语言 1 | IF–AND–THEN 主结构 + 操作语义 + 循环依赖 / 可预测性 |
| 语言 2 | 完整 BNF、逻辑组合、测试生成导向约束                 |
| 语言 3 | 类.属性访问、操作调用语法、属性级可观测性                |
